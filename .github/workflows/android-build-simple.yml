name: Android Build (Simple)

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch or tag to build (e.g., main, v1.2.3)'
        required: true
        type: string
        default: 'main'
      profile:
        description: 'Build profile'
        required: true
        type: choice
        options:
          - preview-apk
          - preview
          - development
        default: 'preview-apk'

env:
  HUSKY: 0

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    timeout-minutes: 60
    defaults:
      run:
        working-directory: apps/mobile

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.branch }}

      - name: Free disk space
        uses: jlumbroso/free-disk-space@main
        with:
          android: false
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        working-directory: .

      - name: Build shared package
        run: pnpm --filter @tracearr/shared build
        working-directory: .

      - name: Setup Expo CLI
        uses: expo/expo-github-action@main
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Set build version
        run: |
          # Get current version from app.json
          CURRENT_VERSION=$(jq -r '.expo.version' app.json)
          CURRENT_VERSION_CODE=$(jq -r '.expo.android.versionCode // 1' app.json)
          
          # Increment version code
          NEW_VERSION_CODE=$((CURRENT_VERSION_CODE + 1))
          
          echo "Current version: $CURRENT_VERSION"
          echo "Current versionCode: $CURRENT_VERSION_CODE"
          echo "New versionCode: $NEW_VERSION_CODE"
          
          # Update app.json with new version code
          jq --argjson vc "$NEW_VERSION_CODE" '.expo.android.versionCode = $vc' app.json > tmp.json && mv tmp.json app.json
          
          echo "Updated versionCode to $NEW_VERSION_CODE"

      - name: Build Android APK
        id: build
        env:
          GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY || '' }}
          EAS_PROJECT_ID: ${{ secrets.EAS_PROJECT_ID }}
        run: |
          # Determine output file based on profile
          if [ "${{ inputs.profile }}" == "preview-apk" ] || [ "${{ inputs.profile }}" == "development" ]; then
            OUTPUT_EXT="apk"
          else
            OUTPUT_EXT="aab"
          fi
          
          BRANCH_NAME="${{ inputs.branch }}"
          BRANCH_NAME="${BRANCH_NAME//\//-}"  # Replace / with -
          OUTPUT_FILE="tracearr-${BRANCH_NAME}-android.${OUTPUT_EXT}"
          
          echo "Building Android $OUTPUT_EXT for profile: ${{ inputs.profile }}"
          echo "Output file: $OUTPUT_FILE"
          
          # Build with EAS
          eas build \
            --platform android \
            --profile ${{ inputs.profile }} \
            --local \
            --output "./${OUTPUT_FILE}" \
            --non-interactive
          
          echo "artifact-path=apps/mobile/${OUTPUT_FILE}" >> $GITHUB_OUTPUT
          echo "Build complete: ${OUTPUT_FILE}"

      - name: Upload build artifact
        uses: actions/upload-artifact@v6
        with:
          name: android-apk
          path: ${{ steps.build.outputs.artifact-path }}
          retention-days: 30

      - name: Build Summary
        run: |
          echo "## Android Build Complete âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch/Tag**: \`${{ inputs.branch }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Profile**: \`${{ inputs.profile }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Output**: \`${{ steps.build.outputs.artifact-path }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download the APK/AAB from the artifacts above ðŸ‘†" >> $GITHUB_STEP_SUMMARY
